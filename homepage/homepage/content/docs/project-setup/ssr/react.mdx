import { CodeGroup } from "@/components/forMdx";
import { Alert } from "@garden-co/design-system/src/components/atoms/Alert";
import { FileName, TabbedCodeGroup, TabbedCodeGroupItem } from "@/components/forMdx";
import StuckCTA from '@/components/docs/snippets/StuckCTA.mdx'

export const metadata = {
  description: "Add server-side rendering to your Jazz app."
};

# Add Server-Side Rendering to your App

This guide will take your simple client-side app to the next level by showing you how to create a server-rendered page to publish your data to the world.

<Alert variant="info" className="mt-4 flex gap-2 items-center">
  This guide builds on the [Front End Quickstart](/docs/react/getting-started/quickstart) to show you how to set up SSR to render public data on the server. Although it should be possible to follow this guide without having completed the quickstart, it's recommended to do so first.
</Alert>

## Creating an agent
In order to work on the server, Jazz needs to create an 'agent', which is a type of credential-less account.

We'll create a new file and export the agent, allowing us to import and use the same agent in multiple pages.

<FileName>app/jazzSSR.ts</FileName>
<CodeGroup className="mt-4 [&_span]:[tab-size:2]" preferWrap>
```tsx
import { createSSRJazzAgent } from "jazz-tools/react/ssr";

export const jazzSSR = createSSRJazzAgent({
  peer: "wss://cloud.jazz.tools/",
});
```
</CodeGroup>

## Telling Jazz to use the SSR agent

We need to tell Jazz to use the SSR agent when we load our data.

<FileName>app/components/JazzWrapper.tsx</FileName>
<CodeGroup className="mt-4 [&_span]:[tab-size:2]" preferWrap>
```tsx
"use client";
import { JazzReactProvider } from "jazz-tools/react";
import { JazzFestAccount } from "@/app/schema";

const apiKey = process.env.NEXT_PUBLIC_JAZZ_API_KEY;

export function JazzWrapper({ children }: { children: React.ReactNode }) {
  return (
    <JazzReactProvider
      sync={{ peer: `wss://cloud.jazz.tools/?key=${apiKey}` }}
      AccountSchema={JazzFestAccount}
      {/* [!code ++:1] */}
      enableSSR
    >
      {children}
    </JazzReactProvider>
  );
}
```
</CodeGroup>

## Making your data public

By default, when you create data in Jazz, it's private, and only accessible to the account that created it. Although Jazz allows you to define complex, role-based permissions, for now, we'll focus on how you can make CoValues public so that our SSR agent can read it.

We'll use the same `withMigration` pattern we used when we created the `JazzFestAccount` to make sure the data is public when bands and festivals are created.

<FileName>app/schema.ts</FileName>
<CodeGroup className="[&_span]:[tab-size:2]" preferWrap>
```ts
import { co, z } from "jazz-tools";

export const Band = co.map({
  name: z.string(), // Zod primitive type
})
// [!code ++:3]
  .withMigration(band => {
    band.$jazz.owner.makePublic()
  });

export const Festival = co.list(Band)
  .withMigration(festival => festival.$jazz.owner.makePublic());

export const JazzFestAccountRoot = co.map({
  myFestival: Festival,
});

export const JazzFestAccount = co
  .account({
    root: JazzFestAccountRoot,
    profile: co.profile(),
  })
  .withMigration((account) => {
    if (!account.$jazz.has('root')) {
      account.$jazz.set('root', {
        myFestival: [],
      });
      // [!code ++:1]
      account.root?.myFestival?.$jazz.owner.makePublic();
    }
  });
```
</CodeGroup>

## Creating a server-rendered page

Now let's set up a page which will be read by the agent we created earlier, and rendered fully on the server.

<FileName>app/festival/[festivalId]/page.tsx</FileName>
<CodeGroup className="mt-4 [&_span]:[tab-size:2]" preferWrap>
```tsx
import { jazzSSR } from "@/app/jazzSSR";
import { Festival } from "@/app/schema";

export default async function ServerSidePage(props: {
  params: { festivalId: string };
}) {
  const { festivalId } = await props.params;
  const festival = await Festival.load(festivalId, {
    loadAs: jazzSSR,
    resolve: {
      $each: {
        $onError: null,
      },
    },
  });
  
  return (
    <main>
      <h1>ðŸŽª Server-rendered Festival {festivalId}</h1>

      <ul>
        {festival?.filter(Boolean).map((band) => {
          if (!band) return null;
          return <li key={band.$jazz.id}>ðŸŽ¶ {band.name}</li>;
        })}
      </ul>
    </main>
  );
}
```
</CodeGroup>

<Alert variant="info" className="mt-4">
  TypeScript might not recognise that `params` is a promise. This is a new feature in Next.js 15, which you can [read more about here](https://nextjs.org/docs/messages/sync-dynamic-apis).
</Alert>

## Linking to your server-rendered page

The last step is to link to your server-rendered page from your `Festival` component so that you can find it easily!

<FileName>app/components/Festival.tsx</FileName>
<CodeGroup className="[&_span]:[tab-size:2]" preferWrap>
```tsx
"use client";
import { useAccount } from "jazz-tools/react";
// [!code ++:1]
import Link from "next/link";
import { JazzFestAccount } from "@/app/schema";

export function Festival() {
  const { me } = useAccount(JazzFestAccount, {
    resolve: { root: { myFestival: true } },
  });
  if (!me) return null; // not loaded yet
  return (
    <>
      <ul>
        {me?.root.myFestival.map(
          (band) => band && <li key={band.$jazz.id}>{band.name}</li>,
        )}
      </ul>
      {/* [!code ++:3] */}
      <Link href={`/festival/${me.root.myFestival.$jazz.id}`}>
        Go to my Server-Rendered Festival Page!
      </Link>
    </>
  );
}
```
</CodeGroup>

## Start your app
Let's fire up your app and see if it works!
<TabbedCodeGroup default="pnpm" savedPreferenceKey="package-manager">
<TabbedCodeGroupItem label="npm">
```sh
npm run dev
```
</TabbedCodeGroupItem>
<TabbedCodeGroupItem label="pnpm">
```sh
pnpm run dev
```
</TabbedCodeGroupItem>
</TabbedCodeGroup>

If everything's going according to plan, your app will load with the home page. You can click the link to your server-rendered page to see your data - fully rendered on the server!

**Congratulations! ðŸŽ‰** You've now set up server-side rendering in your React app. You can use this same pattern to render any page on the server. 

### Not working?
- Did you add `enableSSR` to the `<JazzReactProvider />`?
- Did you add `loadAs: jazzSSR` to `Festival.load`?
- Did you add the migrations to make the data public?

<StuckCTA />

## Next steps
- Learn more about how to [manage complex permissions](/docs/groups/intro) using groups and roles
- Dive deeper into the collaborative data structures we call [CoValues](/docs/schemas/covalues)
- Learn more about migrations in the [accounts and migrations docs](/docs/schemas/accounts-and-migrations)